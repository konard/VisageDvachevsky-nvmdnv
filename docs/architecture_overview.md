# Обзор архитектуры

> **См. также**: [gui_architecture.md](gui_architecture.md) — архитектура GUI редактора.
> **См. также**: [core_runtime_spec.md](core_runtime_spec.md) — API спецификация ядра runtime.
> **См. также**: [editor_engine_interaction.md](editor_engine_interaction.md) — протоколы взаимодействия.

Этот документ описывает архитектуру движка NovelMind и его компонентов на высоком уровне.

## Компоненты системы

NovelMind состоит из трех основных компонентов:

```
+-------------------+     +-------------------+     +-------------------+
|   Visual Editor   |---->|     Compiler      |---->|  Runtime Engine   |
+-------------------+     +-------------------+     +-------------------+
        |                         |                         |
        v                         v                         v
   Project Files            Pack Files (.nmres)       Game Executable
   (JSON/NMScript)          + Compiled Scripts
```

### 1. Движок выполнения (`engine_core/`)

Движок выполнения является основным компонентом, который исполняет визуальные новеллы во время выполнения. Он разработан быть легковесным и быстрым.

#### Архитектура модулей

```
+------------------------------------------------------------------+
|                        Application Layer                          |
+------------------------------------------------------------------+
         |              |              |              |
         v              v              v              v
+----------------+  +--------+  +-----------+  +-------------+
| Scene Manager  |  | Story  |  | Save/Load |  | Localization|
|                |  | Engine |  |  System   |  |   Manager   |
+----------------+  +--------+  +-----------+  +-------------+
         |              |              |              |
         v              v              v              v
+------------------------------------------------------------------+
|                        Core Services                              |
+------------------------------------------------------------------+
|  +-------------+  +----------------+  +------------------------+  |
|  |  Renderer   |  |  Audio System  |  |  Resource Manager      |  |
|  +-------------+  +----------------+  +------------------------+  |
|  +-------------+  +----------------+  +------------------------+  |
|  |   Input     |  |   Scripting    |  |  Virtual File System   |  |
|  +-------------+  +----------------+  +------------------------+  |
+------------------------------------------------------------------+
         |              |              |              |
         v              v              v              v
+------------------------------------------------------------------+
|                      Platform Abstraction                         |
|  +--------+  +--------+  +--------+  +--------+  +--------+      |
|  | Window |  |  Time  |  |  File  |  | Events |  | Thread |      |
|  +--------+  +--------+  +--------+  +--------+  +--------+      |
+------------------------------------------------------------------+
```

#### Основные модули

| Модуль | Пространство имен | Описание |
|--------|-----------|-------------|
| Platform | `NovelMind::platform` | Управление окнами, ввод, таймер, файловый ввод/вывод |
| Renderer | `NovelMind::renderer` | 2D отрисовка спрайтов, текст, эффекты |
| VFS | `NovelMind::vfs` | Виртуальная файловая система с поддержкой шифрования |
| Resource Manager | `NovelMind::resource` | Загрузка ресурсов, кэширование, доступ к данным |
| Scripting | `NovelMind::scripting` | Интерпретатор/виртуальная машина NM Script |
| Scene | `NovelMind::scene` | Граф сцены, слои, объекты |
| Audio | `NovelMind::audio` | Воспроизведение звука и музыки (miniaudio + data provider) |
| Input | `NovelMind::input` | Сопоставление ввода и обработка событий |
| Save | `NovelMind::save` | Сериализация состояния игры (формат v2, слоты/автосейв) |

### 2. Визуальный редактор (`editor/`)

Визуальный редактор - это настольное приложение для создания проектов визуальных новелл.

#### Компоненты редактора

- **Project Dashboard** - Управление проектами, настройки
- **Scene Editor** - Визуальное составление сцены (WYSIWYG)
- **Story Flow Editor** - Дизайн нарративного потока на основе узлов
- **Script Editor** - Редактирование кода NM Script с подсветкой синтаксиса
- **Localization Editor** - Управление переводами
- **Build System** - Интерфейс компиляции проекта

### 3. Компилятор (`compiler/`)

Компилятор преобразует проекты редактора в пакеты, готовые к выполнению.

#### Конвейер компиляции

```
Source Assets          Intermediate           Final Output
-------------          ------------           ------------
Images (.png)    --->  Texture Atlas    --->  Encrypted Pack
Audio (.ogg)     --->  Audio Index      --->  (.nmres)
Scripts (.nms)   --->  Bytecode         --->
Scenes (.json)   --->  Binary Scene     --->
```

## Поток данных

### Модель данных проекта

```
Project
├── Metadata (название, версия, настройки)
├── Characters[]
│   ├── id, name, display_name
│   ├── sprites[]
│   └── default_color
├── Scenes[]
│   ├── id, name
│   ├── layers[]
│   │   └── objects[]
│   └── entry_node
├── Story Graph
│   └── nodes[]
│       ├── DialogueNode
│       ├── ChoiceNode
│       ├── ConditionNode
│       └── TransitionNode
├── Variables[]
│   ├── Flags (bool)
│   └── Counters (int)
├── Localization
│   └── languages[]
│       └── strings{}
└── Assets
    ├── textures/
    ├── audio/
    └── fonts/
```

### Поток данных во время выполнения

1. **Инициализация**
   - Платформенный слой инициализирует окно, ввод, таймер
   - VFS монтирует пакеты и выставляет ресурсные ID
   - ResourceManager кэширует текстуры/шрифты и предоставляет данные аудио
   - AudioManager получает data provider от ResourceManager
   - Движок истории загружает начальную сцену

2. **Главный цикл**
   - Обработка событий ввода
   - Обновление состояния истории
   - Обновление анимаций/эффектов
   - Отрисовка слоев сцены
   - Представление кадра

3. **Исполнение истории**
   - Получение текущего узла из графа истории
   - Выполнение команд узла через скриптовый движок
   - Ожидание ввода игрока (продвижение диалога, выбор)
   - Переход к следующему узлу
   - Снимки состояния через SaveManager (слоты/автосейв)

## Граф зависимостей

```
                    Application
                         |
         +-------+-------+-------+-------+
         |       |       |       |       |
         v       v       v       v       v
      Scene   Story    Save   Local   Audio
         |       |       |       |       |
         +-------+---+---+-------+       |
                     |                   |
                     v                   |
              Resource Manager <---------+
                     |
                     v
            Virtual File System
                     |
                     v
              Platform Layer
```

## Модель потоков

Движок использует однопоточную модель для простоты:

- **Главный поток**: Игровой цикл, отрисовка, ввод, аудиокоманды
- **Аудиопоток** (опционально): Потоковое воспроизведение аудио (управляется аудио-бэкендом)

Планы на будущее:
- Загрузка ресурсов в фоновом потоке
- Выполнение скриптов в выделенном потоке

## Управление памятью

- **Принципы RAII** во всей кодовой базе
- **Умные указатели** для семантики владения
- **Дескрипторы ресурсов** для управляемых ресурсов
- **Пул-аллокаторы** для часто создаваемых/уничтожаемых объектов

## Обработка ошибок

- **Типы Expected/Result** для восстанавливаемых ошибок
- **Исключения отключены** - явное распространение ошибок
- **Система логирования** для отладки и диагностики
- **Утверждения** для проверок на этапе разработки
