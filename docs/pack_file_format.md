# Спецификация формата Pack-файла

Данный документ определяет бинарный формат для файлов пакетов ресурсов NovelMind (`.nmres`).

## Обзор

NovelMind использует пользовательский формат pack-файла для хранения зашифрованных игровых ресурсов. Формат разработан для:

- Защиты ресурсов от простого извлечения
- Поддержки быстрого произвольного доступа к отдельным ресурсам
- Возможности потоковой передачи больших ресурсов
- Обеспечения проверки целостности

## Структура файла

```
+------------------+
|     Header       |  (64 байта)
+------------------+
|   Resource Table |  (переменный)
+------------------+
|   String Table   |  (переменный)
+------------------+
|   Resource Data  |  (переменный)
+------------------+
|     Footer       |  (32 байта)
+------------------+
```

## Формат заголовка (64 байта)

| Смещение | Размер | Тип | Описание |
|--------|------|------|-------------|
| 0x00 | 4 | char[4] | Магическое число: "NMRS" |
| 0x04 | 2 | uint16 | Версия формата (мажорная) |
| 0x06 | 2 | uint16 | Версия формата (минорная) |
| 0x08 | 4 | uint32 | Флаги |
| 0x0C | 4 | uint32 | Количество ресурсов |
| 0x10 | 8 | uint64 | Смещение таблицы ресурсов |
| 0x18 | 8 | uint64 | Смещение таблицы строк |
| 0x20 | 8 | uint64 | Смещение секции данных |
| 0x28 | 8 | uint64 | Общий размер файла |
| 0x30 | 16 | uint8[16] | Хеш содержимого (первые 128 бит SHA-256) |

### Флаги (битовое поле)

| Бит | Название | Описание |
|-----|------|-------------|
| 0 | ENCRYPTED | Ресурсы зашифрованы |
| 1 | COMPRESSED | Ресурсы сжаты |
| 2 | SIGNED | Пакет содержит цифровую подпись |
| 3-31 | Зарезервировано | Должно быть равно нулю |

## Запись таблицы ресурсов (48 байт каждая)

| Смещение | Размер | Тип | Описание |
|--------|------|------|-------------|
| 0x00 | 4 | uint32 | Смещение строки ID ресурса |
| 0x04 | 4 | uint32 | Тип ресурса |
| 0x08 | 8 | uint64 | Смещение данных (от начала секции данных) |
| 0x10 | 8 | uint64 | Сжатый размер |
| 0x18 | 8 | uint64 | Несжатый размер |
| 0x20 | 4 | uint32 | Флаги |
| 0x24 | 4 | uint32 | Контрольная сумма (CRC32) |
| 0x28 | 8 | uint8[8] | Вектор инициализации (для шифрования) |

### Типы ресурсов

| Значение | Тип | Описание |
|-------|------|-------------|
| 0x00 | Unknown | Неопределенный тип |
| 0x01 | Texture | Данные изображения (PNG и т.д.) |
| 0x02 | Audio | Звуковой эффект |
| 0x03 | Music | Фоновая музыка (потоковая) |
| 0x04 | Font | Файл шрифта |
| 0x05 | Script | Скомпилированный байт-код NM Script |
| 0x06 | Scene | Определение сцены |
| 0x07 | Localization | Строки перевода |
| 0x08 | Data | Обобщенный блок данных |

### Флаги ресурса

| Бит | Название | Описание |
|-----|------|-------------|
| 0 | STREAMABLE | Ресурс должен передаваться потоком |
| 1 | PRELOAD | Ресурс должен быть предварительно загружен |
| 2-31 | Зарезервировано | Должно быть равно нулю |

## Таблица строк

Таблица строк хранит все строки ID ресурсов в непрерывном блоке.

```
+------------------+
|  String Count    |  (4 байта, uint32)
+------------------+
|  Offset Table    |  (4 байта * количество)
+------------------+
|   String Data    |  (строки UTF-8 с нулевым терминатором)
+------------------+
```

ID ресурсов хранятся как строки UTF-8 с нулевым терминатором. Таблица смещений содержит смещения от начала секции строковых данных.

## Секция данных ресурсов

Ресурсы хранятся последовательно с опциональным выравниванием. Данные каждого ресурса:

1. Опционально сжимаются (zlib)
2. Шифруются (AES-256-GCM)
3. Хранятся по смещению, указанному в таблице ресурсов

### Выравнивание

- Ресурсы размером более 4KB выравниваются по границам 4KB
- Меньшие ресурсы выравниваются по границам 16 байт
- Выравнивание обеспечивает доступ через отображение в память и потоковую передачу

## Footer (32 байта)

| Смещение | Размер | Тип | Описание |
|--------|------|------|-------------|
| 0x00 | 4 | uint32 | Магическое число footer: "NMRF" |
| 0x04 | 4 | uint32 | CRC32 заголовка + таблицы ресурсов + таблицы строк |
| 0x08 | 8 | uint64 | Временная метка создания пакета (Unix epoch) |
| 0x10 | 4 | uint32 | Номер сборки |
| 0x14 | 12 | uint8[12] | Зарезервировано (должно быть нулем) |

## Подпись пакета

Если установлен флаг `SIGNED`, подпись хранится во внешнем файле рядом с
пакетом с расширением `.sig`.

- Алгоритм подписи: RSA-PKCS1v1.5 с SHA-256
- Подписываемые данные: полный бинарный образ `.nmres` (от байта 0 до конца
  файла, включая footer)
- Проверка подписи выполняется по публичному ключу, встроенному в runtime или
  загруженному из доверенного источника

## Шифрование

### Формирование ключа

Ключ AES-256 передается в runtime извне (например, через окружение или
конфигурацию загрузчика). Формирование/хранение мастер-ключа относится к
пайплайну сборки проекта.

### Шифрование ресурсов

Каждый ресурс шифруется индивидуально с использованием AES-256-GCM:

- Уникальный IV для каждого ресурса (хранится в таблице ресурсов)
- 16-байтовый тег аутентификации добавляется в конец зашифрованных данных
- Ассоциированные данные: ID ресурса + тип + размер

### Хранение ключа

Ключ шифрования **не** должен быть захардкожен в runtime. Он задается через
переменные окружения или внешние источники, согласно `pack_security.md`.

## Сжатие

Ресурсы могут быть сжаты перед шифрованием с использованием **zlib**.

Алгоритм сжатия указывается во флагах пакета. Отдельные ресурсы могут храниться
несжатыми, если сжатие не дает преимущества (например, уже сжатые изображения).

## Процесс сборки пакета

```
1. Сбор всех ресурсов
2. Для каждого ресурса:
   a. Чтение исходного файла
   b. Генерация ID ресурса (хеш исходного пути)
   c. Сжатие, если выгодно
   d. Генерация уникального IV
   e. Шифрование с помощью AES-256-GCM
   f. Вычисление CRC32
3. Построение таблицы ресурсов
4. Построение таблицы строк
5. Запись заголовка (временные хеши)
6. Запись таблицы ресурсов
7. Запись таблицы строк
8. Запись данных ресурсов
9. Вычисление хеша содержимого
10. Запись footer
11. Обновление заголовка с финальным хешем
```

## Процесс загрузки во время выполнения

```
1. Чтение и валидация заголовка
2. Чтение footer и проверка CRC таблицы
3. Загрузка таблицы ресурсов в память
4. Загрузка таблицы строк в память
5. Построение карты ID ресурса -> запись
6. При запросе ресурса:
   a. Поиск записи по ID
   b. Чтение зашифрованных данных из смещения
   c. Расшифровка с использованием IV ресурса
   d. Декомпрессия при необходимости
   e. Проверка CRC32
   f. Возврат расшифрованных данных
```

## Пример структуры ресурсов

```
Header (64 байта)
  Magic: "NMRS"
  Version: 1.0
  Flags: ENCRYPTED | COMPRESSED
  Resource Count: 3
  ...

Resource Table (144 байта = 3 * 48)
  [0] ID: "bg_city" | Type: Texture | Offset: 0 | Size: 245760
  [1] ID: "bgm_main" | Type: Music | Offset: 249856 | Size: 1048576
  [2] ID: "scene_intro" | Type: Script | Offset: 1298432 | Size: 4096

String Table
  Count: 3
  Offsets: [0, 8, 17]
  Data: "bg_city\0bgm_main\0scene_intro\0"

Resource Data
  [0x000000] bg_city данные текстуры (зашифрованы, 245760 байт)
  [0x03D000] bgm_main данные музыки (зашифрованы, 1048576 байт)
  [0x13D000] scene_intro данные скрипта (зашифрованы, 4096 байт)

Footer (32 байта)
  ...
```

## Версионность

| Версия | Изменения |
|---------|---------|
| 1.0 | Начальный формат |

Будущие версии будут сохранять обратную совместимость, где это возможно. Runtime будет отказываться загружать пакеты с несовместимыми мажорными версиями.

## Соображения безопасности

Формат pack-файла обеспечивает защиту от:

- Прямого извлечения файлов из игровой директории
- Простого изменения игровых ресурсов
- Обнаружения подмены через контрольные суммы

Формат НЕ обеспечивает защиту от:

- Целенаправленной обратной разработки
- Дампа памяти во время выполнения
- Патчинга исполняемого файла

Для конфиденциального контента рассмотрите дополнительные юридические меры защиты (DMCA и т.д.) наряду с техническими мерами.
