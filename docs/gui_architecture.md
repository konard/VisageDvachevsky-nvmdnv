# Архитектура GUI редактора NovelMind

## Обзор

Данный документ описывает комплексную архитектуру GUI для редактора NovelMind, полностью перестроенного с использованием Qt 6 Widgets. Архитектура следует модульному, событийно-ориентированному дизайну, вдохновленному профессиональными редакторами, такими как Unreal Engine, Unity и Godot.

## Технологический стек

- **C++20**
- **Qt 6.x**
- **Qt Widgets** (основная UI-фреймворк)
- **QDockWidget / QMainWindow** (система докинга)
- **QGraphicsView / QGraphicsScene** (графы, временная шкала)
- **Qt Model/View** (таблицы, деревья)
- **CMake** (система сборки)
- **Платформы**: Windows / Linux
- **Поддержка High-DPI**
- **Темная тема по умолчанию**

## Уровни архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                      GUI Layer (Qt Widgets)                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │SceneView│ │StoryGraph│ │Inspector│ │ Console │  ...     │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       │           │           │           │                 │
├───────┴───────────┴───────────┴───────────┴─────────────────┤
│                    Editor Core Layer                        │
│  ┌─────────┐ ┌─────────┐ ┌──────────┐ ┌────────────────┐   │
│  │Event Bus│ │Selection│ │Undo/Redo │ │Play-In-Editor  │   │
│  │ System  │ │ System  │ │  System  │ │    Bridge      │   │
│  └─────────┘ └─────────┘ └──────────┘ └────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                    Engine Core (existing)                   │
│  ┌─────────┐ ┌─────────┐ ┌──────────┐ ┌────────────────┐   │
│  │ Scene   │ │Scripting│ │ Assets   │ │   Renderer     │   │
│  │ Graph   │ │  (IR)   │ │  (VFS)   │ │                │   │
│  └─────────┘ └─────────┘ └──────────┘ └────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Экран приветствия/запуска

Редактор имеет современный экран приветствия, вдохновленный Unreal Engine и Unity Hub:

**Возможности:**
- Список последних проектов с временными метками и быстрым доступом
- Шаблоны проектов (Пустой, Визуальная новелла, Симулятор свиданий, Детектив, RPG, Хоррор)
- Кнопки быстрых действий (Новый проект, Открыть проект, Просмотреть примеры)
- Панель обучающих ресурсов со ссылками на документацию
- Функциональность поиска для проектов и шаблонов
- Опция "Не показывать снова" с постоянными настройками
- Флаг командной строки `--no-welcome` для пропуска

**Реализация:**
- `NMWelcomeDialog` - Модальное диалоговое окно, показываемое при запуске
- Интегрировано в поток запуска `main.cpp`
- Использует QSettings для сохранения настроек
- Стилизация в стиле темной темы Unreal

## Основные компоненты

### 1. Шина событий (`QtEventBus`)

Центральная система обмена сообщениями для слабой связи между компонентами.

```cpp
// Типы событий
enum class EditorEventType {
    SelectionChanged,
    PropertyChanged,
    GraphModified,
    ProjectLoaded,
    UndoRedoPerformed,
    PlayModeChanged,
    // ...
};

// Пример использования
QtEventBus::instance().publish(SelectionChangedEvent{selectedIds});
QtEventBus::instance().subscribe<SelectionChangedEvent>([](const auto& e) {
    // Обработка события
});
```

### 2. Система выбора (`QtSelectionManager`)

Централизованное управление выбором во всех панелях.

- Отслеживает выбранные объекты (объекты сцены, узлы графа, элементы временной шкалы, ассеты)
- Поддерживает множественный выбор
- Уведомляет слушателей через шину событий
- Предоставляет историю выбора для навигации

### 3. Система команд отмены/повтора (`NMUndoManager`)

Централизованное управление отменой/повтором с использованием `QUndoStack` Qt.

**Возможности:**
- Глобальный стек отмены/повтора для всех операций редактора
- Паттерн команды для обратимых действий
- Объединение команд для плавных операций (например, непрерывные трансформации)
- Настройка лимита отмены (по умолчанию: 100 операций)
- Отслеживание чистого состояния для несохраненных изменений
- Поддержка макросов для группировки операций
- Интеграция с меню/панелью инструментов главного окна
- Динамическое обновление текста меню

**Базовые классы команд:**
- `PropertyChangeCommand` - Изменения значений свойств
- `AddObjectCommand` / `DeleteObjectCommand` - Жизненный цикл объектов
- `TransformObjectCommand` - Позиция/вращение/масштаб (с объединением)
- `CreateGraphNodeCommand` / `DeleteGraphNodeCommand` - Узлы графа истории
- `ConnectGraphNodesCommand` - Соединения узлов

```cpp
class MoveNodeCommand : public QUndoCommand {
public:
    void undo() override;
    void redo() override;
    bool mergeWith(const QUndoCommand* other) override;
    int id() const override { return 1; }
};

// Использование
NMUndoManager::instance().pushCommand(new PropertyChangeCommand(...));
```

### 4. Мост Play-In-Editor

Управляет встраиванием среды выполнения для предварительного просмотра визуальных новелл в редакторе.

## Дорожная карта поэтапной реализации

### Фаза 0 - Фундамент

**Цели:**
- Каркас приложения с Qt6
- Главное окно с докингом
- Система темы/стиля (темная тема в стиле Unreal)
- Шина событий (базовая)
- Система выбора (базовая)

**Ключевые классы:**
- `NMMainWindow : QMainWindow`
- `NMDockManager`
- `NMStyleManager`
- `QtEventBus`
- `QtSelectionManager`

**Компоненты Qt:**
- `QMainWindow`
- `QDockWidget`
- `QApplication`
- Таблицы стилей Qt (QSS)

**Критерии завершения:**
- [x] Редактор запускается с пустым главным окном
- [x] Функциональный фреймворк докинга
- [x] Применена темная тема
- [x] Шина событий может публиковать/подписываться на события
- [x] Система выбора отслеживает базовый выбор
- [x] Экран приветствия/запуска с последними проектами и шаблонами

### Фаза 1 - Основные панели (только чтение)

**Цели:**
- Панель SceneView (только отображение)
- Панель StoryGraph (только отображение)
- Панель Inspector (свойства только для чтения)
- Панель Console (отображение лога)

**Ключевые классы:**
- `NMSceneViewPanel : NMDockPanel`
- `NMStoryGraphPanel : NMDockPanel`
- `NMInspectorPanel : NMDockPanel`
- `NMConsolePanel : NMDockPanel`

**Компоненты Qt:**
- `QGraphicsView` / `QGraphicsScene`
- `QTreeView` / `QTreeWidget`
- `QListWidget`
- `QTextEdit`

**Критерии завершения:**
- [x] SceneView отображает объекты сцены (без взаимодействия)
- [x] StoryGraph отображает узлы и соединения (без редактирования)
- [x] Inspector показывает свойства выбранного объекта
- [x] Console отображает сообщения лога
- [x] Asset Browser с разделенным представлением дерева/списка
- [x] Панель Hierarchy с разворачиванием/сворачиванием

### Фаза 2 - Редактируемое ядро

**Цели:**
- Выбор объектов во всех панелях
- Редактирование свойств в Inspector
- Система отмены/повтора
- Базовое перетаскивание
- Браузер ассетов (базовый)

**Ключевые классы:**
- `NMAssetBrowserPanel : NMDockPanel`
- `NMPropertyEditor`
- `NMUndoManager`
- Различные подклассы `QUndoCommand`

**Компоненты Qt:**
- `QUndoStack`
- `QMimeData` (перетаскивание)
- Пользовательские виджеты свойств

**Критерии завершения:**
- [x] Система отмены/повтора с QUndoStack
- [x] Паттерн команды для всех операций редактора
- [x] Отмена/повтор интегрированы с главным окном
- [ ] Клик для выбора объектов (фреймворк готов)
- [ ] Множественный выбор с Ctrl+Click (фреймворк готов)
- [x] Inspector редактирует свойства (редактируемые виджеты)
- [x] Ассеты можно просматривать

### Фаза 3 - Продвинутые редакторы

**Цели:**
- Редактирование узлов StoryGraph
- Редактор временной шкалы
- Редактор кривых
- Панель иерархии

**Ключевые классы:**
- `NMTimelinePanel : NMDockPanel`
- `NMCurveEditorPanel : NMDockPanel`
- `NMHierarchyPanel : NMDockPanel`
- `NMGraphNodeItem : QGraphicsItem`
- `NMGraphConnectionItem : QGraphicsItem`

**Компоненты Qt:**
- Пользовательские подклассы `QGraphicsItem`
- `QTimeLine` (для анимаций)
- Пользовательское рисование

**Критерии завершения:**
- [x] Редактор временной шкалы с множественными дорожками
- [x] Управление воспроизведением временной шкалы и прокрутка кадров
- [x] Визуализация ключевых кадров
- [x] Редактор кривых с типами интерполяции
- [x] Визуализация сетки и отрисовка пути кривой
- [x] Создание/удаление/соединение узлов в StoryGraph (Фаза 3.3)
- [ ] Перетаскивание для переупорядочивания в Hierarchy (Фаза 3.3 - будущая работа)

### Фаза 4 - Производственные инструменты

**Цели:**
- Менеджер голоса
- Менеджер локализации
- Панель диагностики
- Настройки сборки

**Ключевые классы:**
- `NMVoiceManagerPanel : NMDockPanel`
- `NMLocalizationPanel : NMDockPanel`
- `NMDiagnosticsPanel : NMDockPanel`
- `NMBuildSettingsPanel : NMDockPanel`

**Критерии завершения:**
- [x] Панель Voice Manager с элементами управления импортом/воспроизведением
- [x] Список голосовых файлов и предварительный просмотр
- [x] Панель Localization Manager с выбором языка
- [x] Редактор таблицы строк для переводов
- [x] Панель Diagnostics с отображением ошибок/предупреждений
- [x] Фильтрация диагностики по типу
- [x] Панель Build Settings с выбором платформы
- [x] Опции конфигурации сборки и настройки вывода

### Фаза 5 - Play-In-Editor

**Цели:**
- Встраивание среды выполнения
- Оверлей отладки
- Точки останова
- Живой инспектор переменных

**Ключевые классы:**
- `NMPlayModeController` - Центральный координатор воспроизведения/паузы/остановки
- `NMPlayToolbarPanel` - UI управления воспроизведением
- `NMDebugOverlayPanel` - Инспектор переменных среды выполнения
- Интеграция точек останова в `NMGraphNodeItem`

**Статус реализации (Фаза 5.0 - Runtime интегрирован): ✅ ЗАВЕРШЕНО**
- [x] Контроллер режима воспроизведения с конечным автоматом (Stopped/Playing/Paused)
- [x] Встроенный runtime host (ScriptRuntime + SceneGraph snapshot)
- [x] Панель инструментов воспроизведения с кнопками Play/Pause/Stop/Step
- [x] Горячие клавиши (F5=Play, F6=Pause, F7=Stop, F10=Step)
- [x] Панель оверлея отладки с 6 вкладками (Variables/CallStack/Instruction/Animations/Audio/Performance)
- [x] Редактирование переменных при паузе (двойной клик для редактирования)
- [x] Система управления точками останова (добавление/удаление/переключение/сохранение)
- [x] Сохранение/загрузка состояния (слоты + авто-сейв)
- [x] Qt сигналы/слоты для всех изменений состояния
- [x] **Визуальные индикаторы точек останова в StoryGraph (красный круг с 3D эффектом)**
- [x] **Подсветка текущего узла во время воспроизведения (пульсирующее зеленое свечение + стрелка выполнения)**
- [x] **Контекстное меню для переключения точки останова (правый клик на узле)**
- [x] **Интеграция в главное окно (панели прикреплены и зарегистрированы)**
- [x] **Автоцентрирование на текущем выполняемом узле**

**Критерии завершения (Фаза 5.0): ✅ ВСЕ ЗАВЕРШЕНО**
- [x] Можно воспроизводить узлы через встроенный runtime
- [x] Оверлей отладки показывает переменные среды выполнения и стек вызовов
- [x] Можно добавлять/удалять точки останова программно
- [x] Можно переключать точки останова через UI (контекстное меню)
- [x] Живые переменные видимы и редактируемы во время паузы
- [x] Визуальная обратная связь для точек останова и состояния выполнения
- [x] Профессиональные горячие клавиши, соответствующие отраслевым инструментам

**Будущая работа (Фаза 5.1+):**
- [ ] Синхронизация воспроизведения временной шкалы
- [ ] Горячая перезагрузка во время режима воспроизведения
- [ ] Продвинутая отладка (условные точки останова, выражения отслеживания)

## Спецификации панелей

### Главное окно + Докинг

Главное окно использует `QMainWindow` с `QDockWidget` для всех панелей. Макет сохраняется/восстанавливается через `QSettings`.

```cpp
class NMMainWindow : public QMainWindow {
    Q_OBJECT
public:
    void saveLayout();
    void restoreLayout();
    void resetToDefaultLayout();

private:
    QMenuBar* m_menuBar;
    QToolBar* m_mainToolBar;
    QStatusBar* m_statusBar;
    // Панели докинга
    NMSceneViewPanel* m_sceneView;
    NMStoryGraphPanel* m_storyGraph;
    // ...
};
```

### Панель SceneView

Отображает сцену визуальной новеллы с объектами, фонами и персонажами.

- Использует `QGraphicsView` с пользовательской `QGraphicsScene`
- Поддерживает панорамирование (средняя кнопка мыши) и масштабирование (колесико прокрутки)
- Наложение сетки (опционально)
- Прямоугольники выбора объектов
- Гизмо трансформации (Фаза 2+)

### Панель StoryGraph

Редактор визуальных скриптов на основе узлов.

- Использует `QGraphicsView` с пользовательскими элементами узлов
- Пользовательские `QGraphicsItem` для узлов
- Соединения кривыми Безье
- Мини-карта (опционально)
- Палитра узлов для создания новых узлов

### Панель Inspector

Редактор свойств для выбранных объектов.

- Использует `QScrollArea` с виджетами свойств
- Группы свойств (сворачиваемые)
- Различные редакторы: текст, число, цвет, выпадающий список, выбор файла
- Редактирование нескольких объектов (общие свойства)

### Панель Console

Вывод лога и ввод команд.

- Использует `QTextEdit` (только чтение) для отображения лога
- Кнопки фильтра (Info, Warning, Error)
- Кнопка очистки
- Опция автопрокрутки
- Поле ввода поиска/фильтра

## Руководство по стилю

### Цветовая палитра (темная тема в стиле Unreal)

```css
/* Цвета фона */
--bg-darkest:     #1a1a1a;   /* Основной фон */
--bg-dark:        #232323;   /* Фон панелей */
--bg-medium:      #2d2d2d;   /* Фон виджетов */
--bg-light:       #383838;   /* Состояния при наведении */

/* Цвета текста */
--text-primary:   #e0e0e0;   /* Основной текст */
--text-secondary: #a0a0a0;   /* Вторичный текст */
--text-disabled:  #606060;   /* Отключенный текст */

/* Акцентные цвета */
--accent-primary: #0078d4;   /* Выбор, фокус */
--accent-hover:   #1a88e0;   /* Состояние при наведении */
--accent-active:  #006cbd;   /* Активное состояние */

/* Цвета статуса */
--error:          #f44336;
--warning:        #ff9800;
--success:        #4caf50;
--info:           #2196f3;

/* Цвета границ */
--border-dark:    #1a1a1a;
--border-light:   #404040;
```

### Типографика

- **Семейство шрифтов**: Segoe UI (Windows), Ubuntu (Linux), системный по умолчанию
- **Базовый размер**: 9pt (11px при 96 DPI)
- **Заголовки**: 10-12pt, полужирный
- **Моноширинный**: Consolas, Ubuntu Mono (для кода/консоли)

### Отступы

- **Отступы панелей**: 4px
- **Расстояние между виджетами**: 4px
- **Расстояние между группами**: 8px
- **Расстояние между секциями**: 16px

### Поведение панелей

- Панели можно прикрепить к любому краю
- Панели можно группировать вкладками с другими панелями
- Панели могут быть отделены как отдельные окна
- Панели запоминают свой размер и позицию
- Двойной клик на заголовке для отделения/прикрепления

### Состояния виджетов

Все интерактивные виджеты имеют различимые визуальные состояния:

- **Нормальное**: Внешний вид по умолчанию
- **Наведение**: Слегка светлее фон
- **Нажато/Активно**: Подсветка акцентным цветом
- **Фокус**: Граница акцентного цвета
- **Отключено**: Уменьшенная непрозрачность, серый текст
- **Выбрано**: Фон акцентного цвета

### Иконки

- Использовать SVG иконки для масштабируемости
- Размер иконок: 16x16 (панель инструментов), 24x24 (крупные действия)
- Монохромные иконки с акцентным цветом для активного состояния

## Структура файлов

```
editor/
├── include/NovelMind/editor/
│   ├── qt/                         # Qt-специфичные реализации
│   │   ├── nm_main_window.hpp
│   │   ├── nm_dock_panel.hpp
│   │   ├── nm_style_manager.hpp
│   │   ├── qt_event_bus.hpp
│   │   ├── qt_selection_manager.hpp
│   │   ├── panels/
│   │   │   ├── nm_scene_view_panel.hpp
│   │   │   ├── nm_story_graph_panel.hpp
│   │   │   ├── nm_inspector_panel.hpp
│   │   │   ├── nm_console_panel.hpp
│   │   │   ├── nm_asset_browser_panel.hpp
│   │   │   ├── nm_hierarchy_panel.hpp
│   │   │   ├── nm_timeline_panel.hpp
│   │   │   ├── nm_curve_editor_panel.hpp
│   │   │   ├── nm_voice_manager_panel.hpp
│   │   │   ├── nm_localization_panel.hpp
│   │   │   ├── nm_diagnostics_panel.hpp
│   │   │   └── nm_build_settings_panel.hpp
│   │   └── widgets/
│   │       ├── nm_property_editor.hpp
│   │       ├── nm_graph_node_item.hpp
│   │       └── nm_timeline_track.hpp
│   └── editor_app.hpp              # Основное приложение (версия Qt)
├── src/
│   ├── qt/
│   │   ├── nm_main_window.cpp
│   │   ├── nm_dock_panel.cpp
│   │   ├── nm_style_manager.cpp
│   │   ├── qt_event_bus.cpp
│   │   ├── qt_selection_manager.cpp
│   │   ├── panels/
│   │   │   └── ... (реализации панелей)
│   │   └── widgets/
│   │       └── ... (реализации виджетов)
│   └── main.cpp                    # Точка входа приложения Qt
└── resources/
    ├── styles/
    │   └── dark_theme.qss
    └── icons/
        └── ... (SVG иконки)
```

## Принципы масштабируемости

1. **Регистрация панелей**: Панели регистрируются с помощью фабрики, что позволяет добавлять новые панели без изменения основного кода.

2. **Событийно-ориентированная коммуникация**: Все панели общаются через шину событий, предотвращая тесную связь.

3. **Паттерн команды**: Все изменения проходят через систему отмены/повтора в виде команд.

4. **Сохранение настроек**: Все пользовательские настройки сохраняются через `QSettings`.

5. **Архитектура плагинов** (Будущее): Поддержка загружаемых плагинов панелей.

## Интеграция с ядром движка

Слой GUI взаимодействует с существующим ядром движка через:

1. **SceneGraph**: Прямой доступ к объектам сцены для отображения и манипулирования
2. **VisualGraph (IR)**: Данные узлов графа истории
3. **VFS**: Загрузка и управление ассетами
4. **Logger**: Вывод консоли
5. **PropertySystem**: Отражение свойств объектов

Существующие бэкенд-реализации (шина событий, система выбора и т. д.) сохраняются и обернуты Qt-совместимыми интерфейсами.
