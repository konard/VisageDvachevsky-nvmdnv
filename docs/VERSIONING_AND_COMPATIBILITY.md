# Политика версионирования и совместимости NovelMind

Этот документ определяет схему версионирования, гарантии стабильности API и политику совместимости для движка и редактора NovelMind.

## Нумерация версий

NovelMind следует [Семантическому версионированию 2.0.0](https://semver.org/) с форматом `MAJOR.MINOR.PATCH`:

- **MAJOR**: Обратно несовместимые изменения публичных API
- **MINOR**: Новые функции, обратно совместимые
- **PATCH**: Исправления ошибок, обратно совместимые

### Текущие версии

| Компонент | Версия | Статус |
|-----------|---------|--------|
| NovelMind Engine | 0.1.0 | Альфа |
| NovelMind Editor | 0.1.0 | Альфа |
| NM Script Language | 1.0 | Стабильный |
| Pack File Format | 1 | Стабильный |
| Project Format | 1 | Стабильный |

## Уровни стабильности

API и форматы файлов классифицируются по уровням стабильности:

### Уровень 1: Стабильный

Эти API считаются стабильными и будут поддерживать обратную совместимость:

- **Синтаксис языка NM Script 1.0**
  - Все документированные ключевые слова и конструкции
  - Объявления персонажей/сцен
  - Диалоги, выборы и операторы управления потоком
  - Встроенные функции и операторы

- **Формат файла пакета v1**
  - Структура заголовка
  - Формат таблицы ресурсов
  - Схема шифрования (AES-256-GCM)
  - Сжатие (zlib)

- **Формат файла проекта v1**
  - Схема `project.json`
  - Соглашения о структуре каталогов
  - Формат ссылок на ресурсы

- **Формат файла сохранений v2 (совместим с v1)**
  - Структура слотов сохранений + автосейв
  - Бинарная сериализация с компрессией и опциональным шифрованием
  - Проверка целостности + теги AES-GCM

### Уровень 2: Предварительный

Эти API функциональны, но могут измениться в минорных версиях:

- **SceneGraph API**
  - `NovelMind::scene::SceneGraph`
  - `NovelMind::scene::SceneObject`
  - `NovelMind::scene::SceneInspectorAPI`

- **ScriptRuntime API**
  - `NovelMind::scripting::ScriptRuntime`
  - `NovelMind::scripting::VM`
  - `NovelMind::scripting::Value`

- **Audio System 2.0 API**
  - `NovelMind::audio::AudioManager`
  - Конфигурация каналов
  - Параметры приглушения озвучки

- **Localization API**
  - `NovelMind::localization::LocalizationManager`
  - Обработка форм множественного числа
  - Форматы импорта/экспорта

- **UI Framework API**
  - Иерархия `NovelMind::ui::Widget`
  - Система компоновки
  - Маршрутизация событий

### Уровень 3: Экспериментальный

Эти API находятся в активной разработке и могут значительно измениться:

- **Editor APIs**
  - `NovelMind::editor::EditorRuntimeHost`
  - `NovelMind::editor::VoiceManager`
  - API панелей и настроек

- **Visual Graph/IR**
  - `NovelMind::scripting::VisualGraph`
  - `NovelMind::scripting::IRNode`
  - Двунаправленная конверсия

- **Plugin System** (запланировано)
  - Регистрация пользовательских узлов
  - Расширения импорта ресурсов

## Политика обратно несовместимых изменений

### Что составляет обратно несовместимое изменение

1. **Изменения API**
   - Удаление или переименование публичных классов, методов или функций
   - Изменение сигнатур методов (параметры, типы возвращаемых значений)
   - Изменение поведения документированных API
   - Удаление значений перечислений

2. **Изменения формата файлов**
   - Изменение структуры файла, требующее миграции
   - Удаление поддержки старых версий формата
   - Изменение схем шифрования или сжатия

3. **Изменения языка**
   - Удаление ключевых слов или конструкций NM Script
   - Изменение семантического значения операторов
   - Превращение ранее валидных скриптов в невалидные

### Как вводятся обратно несовместимые изменения

1. **Объявление**: Обратно несовместимые изменения документируются как минимум за одну минорную версию до внедрения

2. **Устаревание**: Затронутые API помечаются как устаревшие с предупреждениями:
   ```cpp
   [[deprecated("Use newMethod() instead. Will be removed in v1.0.0")]]
   void oldMethod();
   ```

3. **Путь миграции**: Предоставляется четкая документация и инструменты для миграции

4. **Увеличение версии**: Обратно несовместимые изменения приводят к увеличению версии MAJOR (после 1.0.0)

## Миграция форматов

### Формат файла пакета

При изменении формата пакета:

1. Новый формат получает новый номер версии
2. Среда выполнения может читать все старые версии формата
3. Редактор экспортирует только в последний формат
4. Предоставляется инструмент миграции для пакетной конверсии

### Формат проекта

Изменения формата проекта:

1. Редактор определяет версию формата проекта при открытии
2. Предлагает автоматическую миграцию при необходимости
3. Создает резервную копию перед миграцией
4. Документирует все изменения в примечаниях к релизу

### Формат сохранений

Совместимость формата сохранений:

1. Новые версии игры всегда могут загружать старые сохранения
2. Старые версии игры не могут загружать новые сохранения (корректная ошибка)
3. Версия сохранения хранится в заголовке файла сохранения

## Устаревшие API

Текущие устаревшие API (будут удалены в указанной версии):

| API | Устарел в | Удалить в | Замена |
|-----|---------------|-----------|-------------|
| *В настоящее время нет* | - | - | - |

## Версионирование языка NM Script

### Объявление версии языка

Проекты могут объявлять свою версию NM Script:

```json
{
    "nmScriptVersion": "1.0"
}
```

### Эволюция языка

1. **1.x**: Обратно совместимые дополнения
   - Новые опциональные ключевые слова
   - Новые встроенные функции
   - Расширенный синтаксис (обратно совместимый)

2. **2.0**: Может включать обратно несовместимые изменения
   - Зарезервированные ключевые слова становятся активными
   - Более строгие правила парсинга
   - Семантические изменения

### Зарезервированные ключевые слова

Следующие ключевые слова зарезервированы для будущего использования:

```
async await yield import export module
class interface struct trait impl
match switch case default
try catch throw finally
public private protected
static const let var
```

## Тестирование совместимости

### Автоматизированные тесты совместимости

- Модульные тесты для всех API уровня 1 и 2
- Интеграционные тесты с примерами проектов
- Регрессионные тесты для загрузки формата файлов
- Тесты сохранения/загрузки между версиями

### Матрица совместимости

Поддерживается в CI:

| Версия движка | Script v1.0 | Pack v1 | Project v1 | Save v2 |
|---------------|-------------|---------|------------|---------|
| 0.1.x         | ✓           | ✓       | ✓          | ✓       |

## Жизненный цикл поддержки

### Поддержка версий

- **Текущая**: Полная поддержка, исправления ошибок, обновления безопасности
- **Предыдущая минорная**: Только обновления безопасности в течение 6 месяцев
- **Предыдущая мажорная**: Только обновления безопасности в течение 12 месяцев

### Конец жизненного цикла

Когда версия достигает конца жизненного цикла:

1. Объявление за 3 месяца до этого
2. Финальный релиз только с безопасностью
3. Архивируется, но остается доступной для скачивания
4. Документация по миграции поддерживается

## Сообщение о проблемах совместимости

Если вы столкнулись с проблемой совместимости:

1. Проверьте документ [Известные проблемы](./KNOWN_ISSUES.md)
2. Поищите существующие [GitHub Issues](https://github.com/VisageDvachevsky/NM-/issues)
3. Откройте новую проблему с:
   - Номерами версий NovelMind
   - Шагами для воспроизведения
   - Ожидаемым и фактическим поведением
   - Примером проекта, если применимо

## Журнал изменений

Все изменения документируются в [CHANGELOG.md](../CHANGELOG.md) с:

- Номером версии и датой
- Обратно несовместимыми изменениями (выделены)
- Новыми функциями
- Исправлениями ошибок
- Устареваниями
