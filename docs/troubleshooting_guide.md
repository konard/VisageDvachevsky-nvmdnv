# Руководство по устранению неполадок NovelMind

Это руководство поможет вам диагностировать и решать распространённые проблемы при использовании NovelMind.

## Содержание

- [Проблемы с редактором](#проблемы-с-редактором)
- [Проблемы со сборкой](#проблемы-со-сборкой)
- [Проблемы выполнения](#проблемы-выполнения)
- [Проблемы со скриптами](#проблемы-со-скриптами)
- [Проблемы с ресурсами](#проблемы-с-ресурсами)
- [Проблемы производительности](#проблемы-производительности)
- [Платформенные проблемы](#платформенные-проблемы)

---

## Проблемы с редактором

### Редактор не запускается

**Симптомы**: Редактор падает при запуске или показывает пустое окно.

**Решения**:

1. **Проверьте системные требования**
   - Система с поддержкой C++20
   - OpenGL 3.3 или выше
   - Установлен SDL2

2. **Сброс настроек редактора**
   ```bash
   # Удалите файл настроек для сброса
   rm ~/.novelmind/editor_settings.json
   ```

3. **Проверьте драйверы графики**
   - Обновите до последних драйверов GPU
   - Попробуйте запустить с программным рендерингом:
   ```bash
   SDL_RENDER_DRIVER=software ./novelmind_editor
   ```

4. **Проверьте вывод консоли**
   - Запустите из терминала, чтобы увидеть сообщения об ошибках:
   ```bash
   ./novelmind_editor 2>&1 | tee editor.log
   ```

### Редактор зависает или не отвечает

**Симптомы**: Редактор становится неотзывчивым.

**Решения**:

1. **Проверьте бесконечные циклы в скрипте**
   - Откройте панель Console для сообщений об ошибках
   - Проверьте рекурсивные переходы сцен (сцена A -> сцена B -> сцена A)

2. **Загрузка больших ресурсов**
   - Дождитесь завершения загрузки ресурсов (проверьте прогресс-бар)
   - Рассмотрите оптимизацию больших изображений

3. **Принудительное закрытие и восстановление**
   - NovelMind периодически автоматически сохраняет
   - Проверьте `Saves/` для файлов восстановления

### Изменения не сохраняются

**Симптомы**: Правки исчезают после перезапуска редактора.

**Решения**:

1. **Проверьте права записи**
   - Убедитесь, что папка проекта доступна для записи
   - Не работайте в системных директориях

2. **Проверьте путь к проекту**
   - Избегайте специальных символов в пути проекта
   - Держите длину пути разумной (< 200 символов)

3. **Ручное сохранение**
   - Используйте `Ctrl+S` для принудительного сохранения
   - Проверьте **File > Recent Projects** на правильность пути

---

## Проблемы со сборкой

### Сборка не запускается

**Симптомы**: Нажатие Build ничего не делает или показывает ошибку.

**Решения**:

1. **Проверьте конфигурацию сборки**
   - Откройте **Build > Build Settings**
   - Проверьте, что целевая платформа выбрана
   - Убедитесь, что выходной путь существует и доступен для записи

2. **Проверьте проект**
   - Запустите **Tools > Validate Project** сначала
   - Исправьте все обнаруженные ошибки перед сборкой

3. **Проверьте свободное место на диске**
   - Процессу сборки нужно временное пространство
   - Убедитесь, что есть как минимум 500 МБ свободного места

### Отсутствующие ресурсы в сборке

**Симптомы**: Собранная игра не содержит изображений, аудио или других ресурсов.

**Решения**:

1. **Проверьте ссылки на ресурсы**
   - Убедитесь, что все пути к ресурсам в скриптах корректны
   - Используйте относительные пути, а не абсолютные

2. **Пересоберите базу данных ресурсов**
   - **Assets > Rebuild Database**
   - Проверьте ошибки в Console

3. **Проверьте настройки пака**
   - Убедитесь, что ресурсы включены в конфигурацию пака
   - Просмотрите **Build > Pack Settings**

### Сборка падает на определённой платформе

**Симптомы**: Сборка работает на одной платформе, но падает на другой.

**Решения**:

1. **Проверьте требования платформы**
   - Некоторые функции требуют определённых версий ОС
   - Проверьте минимальные требования для целевой платформы

2. **Проверьте совместимость ресурсов**
   - Убедитесь, что форматы изображений кроссплатформенные (PNG, JPEG)
   - Проверьте аудио кодеки (рекомендуется OGG)

3. **Просмотрите логи консоли**
   - Проверьте `Build/logs/` для подробных сообщений об ошибках

---

## Проблемы выполнения

### Игра не запускается

**Симптомы**: Исполняемый файл собранной игры не запускается.

**Решения**:

1. **Проверьте зависимости**
   - Windows: Убедитесь, что установлен Visual C++ Runtime
   - Linux: Проверьте отсутствующие библиотеки с помощью `ldd ./game`
   - macOS: Предоставьте разрешения безопасности в System Preferences

2. **Запустите из терминала**
   ```bash
   ./my_game 2>&1 | tee game.log
   ```

3. **Проверьте целостность файла пака**
   - Убедитесь, что `.pack` файлы не были повреждены при передаче
   - Пересоберите при необходимости

### Сохранение/Загрузка не работает

**Симптомы**: Состояние игры не сохраняется между сессиями.

**Решения**:

1. **Проверьте права записи**
   - Директория сохранения должна быть доступна для записи
   - По умолчанию: `./Saves/` внутри проекта (редактор) или путь, заданный в `SaveManager`

2. **Проверьте данные сохранения**
   - Проверьте, создаются ли файлы сохранения
   - Ищите сообщения о повреждении в консоли

3. **Тестируйте в режиме отладки**
   - Соберите с включённой отладкой
   - Проверьте сообщения Save v2 (сжатие/шифрование) в консоли

### Аудио не воспроизводится

**Симптомы**: Нет звука или музыки в игре.

**Решения**:

1. **Проверьте аудиофайлы**
   - Убедитесь, что файлы существуют в Assets/Music и Assets/Sounds
   - Поддерживаемые форматы: OGG, WAV, MP3

2. **Проверьте настройки аудио**
   - Убедитесь, что системная громкость не выключена
   - Проверьте настройки громкости в игре

3. **Проблемы с аудио драйвером**
   - Linux: Убедитесь, что запущен PulseAudio/ALSA
   - Попробуйте другой аудио бэкенд:
   ```bash
   SDL_AUDIODRIVER=alsa ./my_game
   ```

---

## Проблемы со скриптами

### Синтаксические ошибки в скриптах

**Симптомы**: Красные ошибки в Console о парсинге скриптов.

**Решения**:

1. **Проверьте расположение ошибки**
   - Сообщение об ошибке включает строку и столбец
   - Перейдите к этому месту в Script Editor

2. **Распространённые синтаксические проблемы**
   ```nm
   # Неправильно: Отсутствуют кавычки
   say hero Привет мир

   # Правильно
   say hero "Привет мир"

   # Неправильно: Незакрытая скобка
   scene test {
       say hero "Привет"

   # Правильно
   scene test {
       say hero "Привет"
   }
   ```

3. **Используйте валидатор скриптов**
   - **Tools > Validate Script**
   - Показывает все ошибки и предупреждения

### Переменные не обновляются

**Симптомы**: Значения переменных не изменяются, как ожидается.

**Решения**:

1. **Проверьте область видимости переменной**
   - Глобальные переменные сохраняются между сценами
   - Локальные переменные сбрасываются при смене сцены

2. **Проверьте синтаксис условия**
   ```nm
   # Неправильно: Присваивание вместо сравнения
   if score = 10 { ... }

   # Правильно: Сравнение
   if score == 10 { ... }
   ```

3. **Отладка с помощью консоли**
   - Добавьте отладочный вывод:
   ```nm
   debug "Текущий счёт: " + score
   ```

### Выборы не появляются

**Симптомы**: Меню выбора не показывается или имеет неправильные опции.

**Решения**:

1. **Проверьте условия выборов**
   ```nm
   choice {
       "Опция A" if flag_unlocked -> scene_a
       "Опция B" -> scene_b
   }
   ```
   - Проверьте, что условия оцениваются как истинные

2. **Проверьте структуру выбора**
   - Каждая опция нуждается в тексте и цели
   - Цели должны существовать

3. **Проверьте настройки UI**
   - Меню выбора может быть скрыто
   - Проверьте, что слой UI видимый

---

## Проблемы с ресурсами

### Изображения не отображаются

**Симптомы**: Персонажи или фоны показываются пустыми или как плейсхолдеры.

**Решения**:

1. **Проверьте путь к файлу**
   - Используйте прямые слеши: `Assets/Characters/hero.png`
   - Пути чувствительны к регистру на Linux

2. **Проверьте формат изображения**
   - Поддерживаются: PNG, JPEG, BMP, TGA
   - Рекомендуется: PNG для прозрачности

3. **Проверьте размеры изображения**
   - Максимальный размер текстуры зависит от GPU
   - Типичный лимит: 4096x4096 пикселей

4. **Пересоберите базу данных ресурсов**
   - **Assets > Rebuild Database**

### Импорт ресурсов не работает

**Симптомы**: Невозможно добавить новые ресурсы в проект.

**Решения**:

1. **Проверьте формат файла**
   - Изображения: PNG, JPEG, BMP, TGA
   - Аудио: OGG, WAV, MP3
   - Шрифты: TTF, OTF

2. **Проверьте размер файла**
   - Очень большие файлы могут не импортироваться
   - Рассмотрите сжатие перед импортом

3. **Проверьте имена файлов**
   - Избегайте специальных символов
   - Используйте только буквенно-цифровые, подчёркивание, дефис

### Hot-Reload не работает

**Симптомы**: Изменения ресурсов не отражаются в редакторе.

**Решения**:

1. **Проверьте настройки Hot-Reload**
   - **Edit > Preferences > Hot Reload**: Включено
   - Установите подходящий интервал

2. **Ручное обновление**
   - Правый клик на ресурс > **Reimport**
   - Или **Assets > Refresh All**

3. **Проблемы с файловым наблюдателем**
   - Linux: Проверьте лимиты inotify
   ```bash
   sudo sysctl fs.inotify.max_user_watches=524288
   ```

---

## Проблемы производительности

### Медленная производительность редактора

**Симптомы**: Редактор работает медленно или с задержками.

**Решения**:

1. **Уменьшите качество предпросмотра ресурсов**
   - **Edit > Preferences > Preview Quality**: Low

2. **Закройте неиспользуемые панели**
   - Каждая панель потребляет ресурсы

3. **Оптимизируйте большие проекты**
   - Архивируйте неиспользуемые ресурсы
   - Разбейте на несколько файлов паков

4. **Проверьте системные ресурсы**
   - Закройте другие приложения
   - Мониторьте использование CPU/RAM

### Медленная производительность игры

**Симптомы**: Собранная игра работает медленно.

**Решения**:

1. **Профилируйте игру**
   - Включите профилирование в отладочной сборке
   - Проверьте `profile_results.json`

2. **Оптимизируйте ресурсы**
   - Уменьшите разрешения изображений
   - Сожмите аудиофайлы
   - Используйте атласы текстур

3. **Уменьшите эффекты**
   - Упростите переходы
   - Ограничьте одновременные анимации

4. **Проверьте цикл обновления**
   - Избегайте сложной логики в обновлении сцены
   - Кэшируйте часто используемые значения

### Высокое использование памяти

**Симптомы**: Игра использует слишком много RAM.

**Решения**:

1. **Оптимизируйте размеры изображений**
   - Не используйте изображения больше необходимого
   - Масштабируйте фоны до разрешения экрана

2. **Выгружайте неиспользуемые ресурсы**
   - Ресурсы по умолчанию кэшируются
   - Очищайте кэш между главами:
   ```nm
   clear_cache
   ```

3. **Проверьте утечки памяти**
   - Соберите с включённым ASAN:
   ```bash
   cmake -DNOVELMIND_ENABLE_ASAN=ON ..
   ```

---

## Платформенные проблемы

### Windows

**Проблема**: "VCRUNTIME140.dll не найден"
- Установите Visual C++ Redistributable 2022

**Проблема**: Windows Defender блокирует исполняемый файл
- Добавьте папку игры в исключения
- Или подпишите исполняемый файл для распространения

**Проблема**: Ошибка "Путь слишком длинный"
- Держите пути проектов короткими
- Включите поддержку длинных путей в Windows

### Linux

**Проблема**: "libSDL2 не найдена"
```bash
sudo apt-get install libsdl2-2.0-0  # Debian/Ubuntu
sudo dnf install SDL2               # Fedora
```

**Проблема**: Нет разрешения на выполнение
```bash
chmod +x ./my_game
```

**Проблема**: Проблемы с отображением Wayland
```bash
SDL_VIDEODRIVER=x11 ./my_game
```

### macOS

**Проблема**: "Не может быть открыт, потому что разработчик не может быть проверен"
- System Preferences > Security & Privacy > Allow
- Или правый клик > Open

**Проблема**: Масштабирование Retina дисплея
- Проверьте настройки HiDPI в конфигурации игры
- Убедитесь, что ресурсы имеют @2x варианты при необходимости

---

## Получение дополнительной помощи

Если вы не можете решить свою проблему:

1. **Поиск существующих проблем**
   - [GitHub Issues](https://github.com/VisageDvachevsky/NM-/issues)

2. **Сообщить об ошибке**
   - Укажите версию NovelMind
   - Укажите операционную систему
   - Укажите шаги для воспроизведения
   - Прикрепите соответствующие файлы логов

3. **Проверьте документацию**
   - [Обзор архитектуры](architecture_overview.md)
   - [Спецификация NM Script](nm_script_specification.md)

4. **Включите подробное логирование**
   ```bash
   NOVELMIND_LOG_LEVEL=debug ./novelmind_editor
   ```

---

## Расположение файлов логов

| Платформа | Расположение |
|-----------|--------------|
| Windows | `%APPDATA%\NovelMind\logs\` |
| Linux | `~/.novelmind/logs/` |
| macOS | `~/Library/Application Support/NovelMind/logs/` |

Включайте эти логи при сообщении о проблемах.
